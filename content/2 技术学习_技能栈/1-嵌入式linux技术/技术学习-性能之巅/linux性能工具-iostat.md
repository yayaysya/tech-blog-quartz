# iostat 详解指南

## 简介

**iostat** (Input/Output Statistics) 是 Linux/Unix 系统中用于监控系统 I/O 设备负载的重要工具，属于 sysstat 软件包的一部分。它能够实时显示 CPU 使用率和磁盘 I/O 统计信息，帮助系统管理员识别性能瓶颈。

## 主要作用

- **监控磁盘 I/O 性能**：分析磁盘读写速度、IOPS、队列长度等关键指标
- **识别性能瓶颈**：发现磁盘 I/O 是否成为系统性能瓶颈
- **容量规划**：为存储系统扩容提供数据支撑
- **故障诊断**：定位磁盘相关的性能问题
- **趋势分析**：通过持续监控了解系统 I/O 模式变化

## 基本语法

```bash
iostat [选项] [间隔时间] [采样次数]
```

## 重要参数详解

### CPU 相关参数

| 参数        | 含义                       | 实际作用              |
| --------- | ------------------------ | ----------------- |
| `%user`   | 用户态 CPU 使用率              | 反映应用程序计算密集度       |
| `%nice`   | 低优先级进程 CPU 使用率           | 显示后台任务对系统的影响      |
| `%system` | 内核态 CPU 使用率              | 反映系统调用和中断处理开销     |
| `%iowait` | **等待 I/O 完成的 CPU 时间百分比** | **关键指标：高值表示磁盘瓶颈** |
| `%steal`  | 虚拟化环境中被其他虚拟机占用的 CPU 时间   | 虚拟化性能监控           |
| `%idle`   | CPU 空闲时间百分比              | 系统整体负载评估          |

### 磁盘 I/O 关键参数

|参数|含义|实际作用|重要程度|
|---|---|---|---|
|`Device`|设备名称|标识监控的存储设备|-|
|`tps`|**每秒传输次数**|**衡量磁盘忙碌程度，包括读写操作**|⭐⭐⭐⭐⭐|
|`kB_read/s`|每秒读取的千字节数|评估读密集型应用的磁盘压力|⭐⭐⭐⭐|
|`kB_wrtn/s`|每秒写入的千字节数|评估写密集型应用的磁盘压力|⭐⭐⭐⭐|
|`kB_read`|累计读取的千字节数|长期读取量统计|⭐⭐|
|`kB_wrtn`|累计写入的千字节数|长期写入量统计|⭐⭐|

### 扩展参数（使用 -x 选项）

| 参数         | 含义                | 实际作用                   | 重要程度  |
| ---------- | ----------------- | ---------------------- | ----- |
| `r/s`      | 每秒读请求数            | 读操作频率分析                | ⭐⭐⭐⭐  |
| `w/s`      | 每秒写请求数            | 写操作频率分析                | ⭐⭐⭐⭐  |
| `rkB/s`    | 每秒读取千字节数          | 读取带宽监控                 | ⭐⭐⭐⭐  |
| `wkB/s`    | 每秒写入千字节数          | 写入带宽监控                 | ⭐⭐⭐⭐  |
| `rrqm/s`   | 每秒合并的读请求数         | I/O 调度器效率评估            | ⭐⭐⭐   |
| `wrqm/s`   | 每秒合并的写请求数         | I/O 调度器效率评估            | ⭐⭐⭐   |
| `%rrqm`    | 读请求合并百分比          | 顺序读操作比例                | ⭐⭐⭐   |
| `%wrqm`    | 写请求合并百分比          | 顺序写操作比例                | ⭐⭐⭐   |
| `r_await`  | **平均读请求等待时间（毫秒）** | **读操作性能关键指标**          | ⭐⭐⭐⭐⭐ |
| `w_await`  | **平均写请求等待时间（毫秒）** | **写操作性能关键指标**          | ⭐⭐⭐⭐⭐ |
| `aqu-sz`   | **平均队列长度**        | **磁盘繁忙程度指标**           | ⭐⭐⭐⭐⭐ |
| `rareq-sz` | 平均读请求大小（扇区）       | I/O 模式分析               | ⭐⭐⭐   |
| `wareq-sz` | 平均写请求大小（扇区）       | I/O 模式分析               | ⭐⭐⭐   |
| `svctm`    | **平均服务时间（毫秒）**    | **磁盘响应能力**             | ⭐⭐⭐⭐  |
| `%util`    | **设备利用率百分比**      | **最关键指标：接近100%表示磁盘饱和** | ⭐⭐⭐⭐⭐ |

## 常用命令示例

### 基本监控

```bash
# 显示一次统计信息
iostat

# 每 2 秒显示一次，共显示 5 次
iostat 2 5

# 只显示磁盘统计信息
iostat -d

# 只显示 CPU 统计信息
iostat -c
```

### 详细监控

```bash
# 显示扩展统计信息
iostat -x

# 以 MB 为单位显示
iostat -m

# 显示设备利用率
iostat -x 1

# 监控特定设备
iostat -x sda 2
```

### 高级应用

```bash
# 生成报告格式输出
iostat -t -x 2 10

# 监控所有设备的详细信息
iostat -x -d 1

# 结合其他工具使用
iostat 1 | grep -E "(Device|sda)"
```

## 性能分析要点

### 关键性能指标阈值

- **%iowait > 20%**：可能存在 I/O 瓶颈
- **%util > 80%**：磁盘接近饱和，需要关注
- **await > 20ms**：响应时间较慢，影响性能
- **aqu-sz > 2**：队列积压严重，磁盘压力大
- **tps**：根据磁盘类型判断（HDD: 100-200, SSD: 1000+）

### 性能优化建议

1. **高 %iowait**
    - 检查磁盘硬件状态
    - 优化应用程序 I/O 模式
    - 考虑使用更快的存储设备

2. **高 %util 但低 tps**
    - 可能存在大量小 I/O 操作
    - 优化应用程序减少随机访问
    - 调整文件系统参数

3. **高 await 时间**
    - 检查磁盘健康状况
    - 优化 I/O 调度器设置
    - 考虑 RAID 配置优化

## 实际应用场景

### 数据库性能监控

```bash
# 持续监控数据库服务器磁盘性能
iostat -x 1 | awk '/sda/ {printf "Time: %s, Util: %.2f%%, Await: %.2f ms\n", strftime("%H:%M:%S"), $10, $9}'
```

### Web 服务器日志分析

```bash
# 监控日志磁盘写入性能
iostat -x 1 | grep -E "(Device|log)"
```

### 虚拟化环境监控

```bash
# 监控虚拟机磁盘性能
iostat -x 2 | grep -v "^$"
```

## 注意事项

1. **统计数据的时效性**：首次运行显示的是系统启动以来的平均值
2. **采样间隔选择**：间隔太短可能影响系统性能，太长可能错过瞬时问题
3. **结合其他工具**：建议与 iotop、dstat 等工具配合使用
4. **虚拟化环境**：虚拟机中的统计可能不完全准确
5. **SSD vs HDD**：不同类型存储设备的性能基准不同

iostat 是系统性能监控的核心工具之一，掌握其关键参数的含义和应用场景，对于系统性能优化和故障诊断至关重要。